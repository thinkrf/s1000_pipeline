name: S1000 Agent Installer Package Pipeline

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      releaseTag:
        description: 'The s1000 backend tag that you would like to create a release. Ex: 1.3.0'     
        required: true    
      linuxChangelogDescription:
        description: 'A sentence or short paragraph describing the changes since last packaging'
        required: false

jobs:
  build:
    name: ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config: 
            name: "Windows Latest MSVC",
            os: windows-latest,
            artifact: "windows_msvc.7z",
            build_type: "Release",
            cc: "cl",
            cxx: "cl",
            #Visual Studio 2019 is specifically needed in order to build, as the location (and sometimes name) of this vital file changes between versions
            environment_script: "C:/Program Files (x86)/Microsoft Visual Studio/2019/Enterprise/VC/Auxiliary/Build/vcvars64.bat",
            archiver: "7z a",
            generators: "Visual Studio 16 2019"
        # 
        #     name: "Ubuntu_Latest_GCC",
        #     os: ubuntu-latest,
        #     artifact: "ubuntu_gcc.7z",
        #     build_type: "Release",
        #     cc: "gcc",
        #     cxx: "g++",
        #     archiver: "7z a",
        #     generators: "Ninja"
        #             

    steps:       

    # - name: Install dependencies on ubuntu
    #   if: startsWith(matrix.config.name, 'Ubuntu_Latest_GCC')
    #   run: |
    #     sudo apt-get update
    #     sudo apt-get install ninja-build cmake libwebsocketpp-dev python
    #     ninja --version
    #     cmake --version
    #     gcc --version

    - name: Install Bitbuket SSH key
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.BITBUCKET_SSH_PRIVATE_KEY }}
        name: id_rsa_bit
        known_hosts: ${{ secrets.KNOWN_HOSTS_BITBUCKET }}
        config: |
          Host bitbucket-git
            HostName bitbucket.org
            IdentityFile ~/.ssh/id_rsa_bit
        if_key_exists: replace


     - name: Inno-setup
       shell: pwsh
       run: |
         Invoke-WebRequest -OutFile inno.exe -Uri https://jrsoftware.org/download.php/is.exe
         Start-Process -Wait -FilePath $PWD\inno.exe -Argument "/silent" -PassThru


    # - name: Install boost
    #   run: |
    #     Invoke-WebRequest -OutFile boost.exe -Uri https://sourceforge.net/projects/boost/files/boost-binaries/1.80.0/boost_1_80_0-msvc-14.1-32.exe/download
    #     Start-Process -Wait -FilePath $PWD\boost.exe -Argument "/silent" -PassThru

    # - name: Install boost
    #   uses: MarkusJx/install-boost@v2.4.1
    #   id: install-boost
    #   with:
    #       # REQUIRED: Specify the required boost version
    #       # A list of supported versions can be found here:
    #       # https://github.com/MarkusJx/prebuilt-boost/blob/main/versions-manifest.json
    #       boost_version: 1.80.0
    #       # OPTIONAL: Specify a custon install location
    #       # boost_install_dir: C:\boost
    #       # OPTIONAL: Specify a platform version
    #       platform_version: 2019
    #       # OPTIONAL: Specify a toolset
    #       toolset: msvc
    #       cache: true

    - name: Build Boost
      id: boost
      uses: egor-tensin/build-boost@v1
      with:
        version: 1.80.0
        libraries: filesystem regex iostreams system
        platform: x64
        configuration: Release
        static-runtime: 1
        static: 1

    - name: Show paths
      run: |
        printf 'Boost has been unpacked to: %s\n' '${{ steps.boost.outputs.root }}'
        printf 'Libraries can be found here: %s\n' '${{ steps.boost.outputs.librarydir }}'
      shell: bash

    # - name: Test
    #   run: dir ${{ steps.install-boost.outputs.BOOST_ROOT }}/boost/range/algorithm

    # - name: Install Node.js and NPM
    #   uses: actions/setup-node@v1
    #   with:
    #     node-version: 14

    - name: Retrieve Backend Repository
      run: |
        git clone git@bitbucket-git:thinkrfsoftware/s1000_backend.git
        cd s1000_backend
        git checkout ${{ github.event.inputs.releaseTag }}
        cd ..
      
    - name: Retrieve Installer Repository
      run: |
        git clone git@bitbucket.org:thinkrfsoftware/s1000-installer.git      
    
    
    - name: Get WebsocketPP
      run: |
        git clone https://github.com/zaphoyd/websocketpp.git
        mkdir build && cd build
        cmake .. -DCMAKE_INSTALL_PREFIX="C:/Program Files/websocketpp"
        cmake --build . --target install --config Release
    
    
    - name: Get OpenSSL
      run: |
        Invoke-WebRequest -OutFile openssl.exe -Uri https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/openssl-for-windows/openssl-0.9.8k_WIN32.zip
        Start-Process -Wait -FilePath $PWD\openssl.exe -Argument "/silent" -PassThru
        set OPENSSL_ROOT_DIR="C:\Program Files\openssl-0.9.8k_WIN32"
        set OPENSSL_INCLUDE_DIR="C:\Program Files\openssl-0.9.8k_WIN32\include"
        set OPENSSL_LIBRARIES="C:\Program Files\openssl-0.9.8k_WIN32\lib"
        
        
    - name: Call Package Builder
      run: |
        cd s1000-installer
        python installer-builder.py ../s1000_backend


    # - name: Configure CMake
    #   run: cmake . -DCMAKE_BUILD_TYPE=$BUILD_TYPE -B build
    #   env:
    #       BOOST_ROOT: ${{ steps.install-boost.outputs.BOOST_ROOT }}

    # - name: Boost Library
    #   shell: pwsh
    #   run: |
    #     Invoke-WebRequest -OutFile boost.zip -Uri https://boostorg.jfrog.io/artifactory/main/release/1.80.0/source/boost_1_80_0.zip
    #     7z x boost.zip -oboost
    #     cd boost/boost_1_80_0
    #     .\bootstrap.bat
    #     .\b2         
